# Тестирование приложения аудиостриминга

В данном документе описаны подходы к тестированию и инструкции по запуску тестов для приложения аудиостриминга.

## Типы тестов

### 1. Тестовые данные
Реализовано автоматическое заполнение базы данных тестовыми данными, которые включают:
- Пользователей с разными ролями (admin, user)
- Треки (публичные и приватные)
- Плейлисты
- Тестовые аудиофайлы

### 2. Валидация ролевой модели
Тесты для проверки работы ролевой модели безопасности, которые включают:
- Тесты middleware проверки аутентификации (`checkAuth`)
- Тесты middleware проверки ролей (`roleMiddleware`)
- Тесты middleware проверки владения ресурсом (`ownerMiddleware`)
- Тестирование реакции на некорректные данные и токены

### 3. Фаззинг-тестирование
Всего реализовано 8 фаззинг-тестов:
1. `authFuzzer` - тестирование API аутентификации
2. `trackFuzzer` - тестирование API треков
3. `playlistFuzzer` - тестирование API плейлистов
4. `roleFuzzer` - тестирование API с разными ролями и токенами
5. `trackOwnershipFuzzer` - тестирование проверки владения треками
6. `playbackSyncFuzzer` - тестирование API синхронизации воспроизведения
7. `validationFuzzer` - тестирование валидации входных данных
8. `trackFilterFuzzer` - тестирование фильтрации треков

## Как запустить тесты

### Установка зависимостей
```bash
cd server
npm install
```

### Заполнение тестовыми данными
```bash
npm run seed:data
```

### Запуск всех тестов
```bash
npm run test:all
```

### Запуск отдельных тестов
1. Только юнит-тесты:
   ```bash
   npm run test:unit
   ```

2. Только интеграционные тесты:
   ```bash
   npm run test:integration
   ```

3. Только фаззинг-тесты:
   ```bash
   npm run test:fuzzing
   ```

4. Только тесты ролевой модели:
   ```bash
   npm run test:role
   ```

5. Запуск с покрытием кода:
   ```bash
   npm run test:coverage
   ```

## Результаты тестирования

### Безопасность ролевой модели
Тесты показывают, что ролевая модель безопасности корректно:
- Проверяет наличие и валидность токена авторизации
- Проверяет роли пользователей для доступа к ресурсам
- Проверяет владение ресурсами (используя поля userId и user_id)
- Позволяет администраторам получать доступ ко всем ресурсам

### Фаззинг-тестирование
Фаззинг-тесты позволили выявить и устранить проблемы:
- Некорректной обработки невалидных токенов
- Обработки некорректных данных в запросах
- Проблем с проверкой прав доступа при использовании разных полей ID пользователя
- Уязвимостей при работе с фильтрацией треков
- Некорректной работы синхронизации воспроизведения

## Улучшения безопасности

После проведения тестирования были внесены следующие улучшения:
- Улучшена проверка владельца ресурса (учитываются оба поля: userId и user_id)
- Добавлена дополнительная валидация входных данных во всех контроллерах
- Исправлена логика фильтрации треков
- Добавлена проверка принадлежности треков пользователю при сохранении позиции воспроизведения
- Реализован сброс данных воспроизведения при выходе из системы 